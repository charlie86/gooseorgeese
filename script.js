// Song database - YouTube video IDs for Goose and Geese
// Using official/verified uploads that allow embedding
const songs = {
    goose: [
        { title: "Turbulence & The Night Rays", videoId: "y3m8u1O4F3w" },
        { title: "Echo Of A Rose", videoId: "nw7dUSIt1Lg" },
        { title: "The Empress of Organos", videoId: "ZZ3FaBno_mM" },
        { title: "Factory Fiction", videoId: "ZZzddsbYFYs" },
        { title: ".....", videoId: "WjfQQGI-TXY" },
        { title: "Hot Love & The Lazy Poet", videoId: "TRSS-tDSMf0" },
        { title: "Madalena", videoId: "JPB6rI-eo8E" },
        { title: "Mr. Action", videoId: "AJR2X1QvnjE" },
        { title: "Dr. Darkness", videoId: "3MI16H0WzhM" },
        { title: "Jed Stone", videoId: "2NaEAVVpmOw" },
        { title: "Rockdale", videoId: "1JIzpfaiEsc" },
        { title: "Royal", videoId: "utIfTvZ-prw" },
        { title: "Tumble", videoId: "ayI_d54CL38" },
        { title: "Red Bird → Atlas Dogs", videoId: "jUbRIFuQW-o" },
        { title: "State Of The Art (A.E.I.O.U)", videoId: "wwxqyhG6Y7M" },
        { title: "Hungersite", videoId: "ZTsswP8lroo" },
        { title: "Animal", videoId: "sgfFtjAwSeM" },
        { title: "Rosewood Heart", videoId: "XtajDmJTByQ" },
        { title: "Amongster", videoId: "laULRNr_5r4" },
        { title: "A Western Sun", videoId: "5kIRHug3ZoU" },
        { title: "Echo of a Rose → Psycho Killer", videoId: "24uGUTuTJdU" },
        { title: "Dripfield", videoId: "eWLYzXeAI3k" },
        { title: "Moby Dick", videoId: "O08N1antrK4" },
        { title: "Dustin Hoffman → Big Modern!", videoId: "giYoDlziqFQ" },
        { title: "This Old Sea → Atlas Dogs", videoId: "iyt2H551hhk" },
        { title: "Silver Rising", videoId: "tLcTjeoGu4s" },
        { title: "Your Direction", videoId: "OEMA3JJN1rU" },
        { title: "Empress → fast:slow → Empress", videoId: "pVW2Xrv5ntw" },
        { title: "Atlas Dogs → Rockdale", videoId: "jh_JvB7oZzE" },
        { title: "Everything Must Go", videoId: "M7Dk_Ls9UT4" },
        { title: "Dustin Hoffman", videoId: "ybcUYXbRaO4" },
        { title: "Feel It Now", videoId: "iUm0c5iVvYY" },
        { title: "How It Ends", videoId: "OPqk0J9AFf0" },
        { title: "Silver Rising", videoId: "MUpW7MN17DA" },
        { title: "Animal", videoId: "KqTk186Tnec" },
        { title: "Iguana Song", videoId: "A-ww_Lcfatc" },
        { title: "Red Bird", videoId: "H1ZxljfyLJQ" },
        { title: "California Magic", videoId: "4TUjlAgfvyg" },
        { title: "Atlas Dogs", videoId: "1V_9mIFdrg0" },
        { title: "Thatch", videoId: "knFCidcRjBs" },
        { title: "Your Direction", videoId: "LoJVGpmuwm0" },
        { title: "Lead Up", videoId: "RnwzffaFWGw" },
        { title: "726 / Madhuvan", videoId: "1o4tv956zgk" },
        { title: "Borne → Hungersite → Dripfield", videoId: "5Z2kUXvXDxk" },
        { title: "Madhuvan / Red Bird", videoId: "hCLfFRdPXtM" },
        { title: "Give It Time", videoId: "DF2QKZ823HY" },
        { title: "Help/Slip Franklins", videoId: "qpU61qb0024" },
        { title: "One In, One Out → D&B&Flamingos → Rockdale", videoId: "7ZUQyFMqHi0" },
        { title: "Hungersite → Flodown", videoId: "SH_vXlKckBk" },
        { title: "Kashmir", videoId: "lBRH2PmTl9s" }
    ],
    geese: [
        { title: "Au Pays du Cocaine", videoId: "RGE-JRsJ2uo" },
        { title: "Taxes", videoId: "Phh3oVCtzBg" },
        { title: "Cobra", videoId: "y3udPM2ehAo" },
        { title: "Islands of Men", videoId: "q5BR_2ubivc" },
        { title: "Half Real", videoId: "q6MNbB9YeFQ" },
        { title: "Getting Killed", videoId: "T5nf0kFQddc" },
        { title: "Bow Down", videoId: "HMKrmLcA0VQ" },
        { title: "Husbands", videoId: "H2qb7k8SZLI" },
        { title: "Long Island City Here I Come", videoId: "1HG5eII55JA" },
        { title: "100 Horses", videoId: "DT0RBSpDiKo" },
        { title: "Trinidad", videoId: "nT43dsYhw0k" },
        { title: "Space Race", videoId: "qWo1Oh_cSf0" },
        { title: "Killing My Borrowed Time", videoId: "iLT0gvJgLoU" },
        { title: "Art of War", videoId: "3nyelTT72Pg" },
        { title: "Jesse", videoId: "fr4NSDBtK6o" },
        { title: "St. Elmo", videoId: "FT-KOE9lRQY" },
        { title: "Crusades", videoId: "n2KXaLqz2w8" },
        { title: "Undoer", videoId: "NB97ZCzNsxA" },
        { title: "Gravity Blues", videoId: "HY3CPF4FkYU" },
        { title: "2122", videoId: "9HN0VuyMW-s" },
        { title: "Tomorrow's Crusades", videoId: "BzqGVlt38PI" },
        { title: "Domoto", videoId: "1zF0VBP2iiQ" },
        { title: "I See Myself", videoId: "deFElPQMasw" },
        { title: "Mysterious Love", videoId: "IeM0YJZGMsM" },
        { title: "4D Country", videoId: "0m1abZODAJ0" },
        { title: "Cowboy Nudes", videoId: "LvHsLdYXfaY" },
        { title: "Disco", videoId: "LxXfvdQ6rzI" },
        { title: "Imploding House", videoId: "unhK5Zq6VrE" },
        { title: "First World Warrior", videoId: "_7T4xxwsl6k" },
        { title: "Bottle", videoId: "fivLPU-9QaU" },
        { title: "Rain Dance", videoId: "K7EtdoMkBIg" },
        { title: "Exploding House", videoId: "Eaj3rS4-zJY" },
        { title: "Fantasies / Survival", videoId: "39fq_85fcwk" },
        { title: "Opportunity is Knocking", videoId: "0xfQdBCYjGc" },
        { title: "Projector", videoId: "d6uVeDbxKAs" },
        { title: "Low Era", videoId: "__bi2jKX_AU" }
    ]
};

let currentBand = null;
let correctCount = 0;
let totalCount = 0;
let player = null;
let currentSong = null;
let playerReady = false;
// Optional: set a YouTube Data API key here to fetch video durations without loading any iframe.
// If you don't have an API key leave this as an empty string and the code will fall back
// to a short-lived hidden IFrame to read duration.
const YOUTUBE_API_KEY = '';

const playRandomBtn = document.getElementById('play-random');
const playerSection = document.getElementById('player-section');
const songTitleDiv = document.getElementById('song-title');
const playAudioBtn = document.getElementById('play-audio');
const guessGooseBtn = document.getElementById('guess-goose');
const guessGeeseBtn = document.getElementById('guess-geese');
const resultDiv = document.getElementById('result');
const statsDiv = document.getElementById('stats');
const correctCountSpan = document.getElementById('correct-count');
const totalCountSpan = document.getElementById('total-count');

playRandomBtn.addEventListener('click', playRandomSong);
playAudioBtn.addEventListener('click', startAudio);
guessGooseBtn.addEventListener('click', () => makeGuess('goose'));
guessGeeseBtn.addEventListener('click', () => makeGuess('geese'));

// Load YouTube IFrame API
const tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// YouTube API ready callback
window.onYouTubeIframeAPIReady = function() {
    playerReady = true;
};

function playRandomSong() {
    // Detect if mobile device (at top to use throughout function)
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
        || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
    
    // 50/50 selection between Goose and Geese
    currentBand = Math.random() < 0.5 ? 'goose' : 'geese';
    
    // Randomly select a song from that band
    const bandSongs = songs[currentBand];
    currentSong = bandSongs[Math.floor(Math.random() * bandSongs.length)];
    
    // Show song title
    if (isMobile) {
        songTitleDiv.textContent = '♪ Ready to play...';
        songTitleDiv.style.fontStyle = 'italic';
    } else {
        songTitleDiv.textContent = '♪ Loading...';
        songTitleDiv.style.fontStyle = 'italic';
    }
    
    // Show player section
    playerSection.classList.remove('hidden');
    playRandomBtn.classList.add('hidden');
    resultDiv.classList.add('hidden');
    
    // Only show play button on mobile
    if (isMobile) {
        playAudioBtn.classList.remove('hidden');
    } else {
        playAudioBtn.classList.add('hidden');
    }
    
    // Disable guess buttons until audio plays
    guessGooseBtn.disabled = true;
    guessGeeseBtn.disabled = true;
    const playerDiv = document.getElementById('youtube-player');

    // Helper: parse ISO 8601 duration (e.g. PT3M45S) -> seconds
    const parseISODuration = (iso) => {
        const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return 0;
        const hours = parseInt(match[1] || 0, 10);
        const minutes = parseInt(match[2] || 0, 10);
        const seconds = parseInt(match[3] || 0, 10);
        return hours * 3600 + minutes * 60 + seconds;
    };

    // Get duration via YouTube Data API if API key is provided, otherwise
    // fall back to a short-lived hidden IFrame that reads duration via getDuration().
    const getVideoDuration = (videoId) => {
        if (YOUTUBE_API_KEY) {
            const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`;
            return fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.items && data.items.length) {
                        const iso = data.items[0].contentDetails.duration;
                        return parseISODuration(iso);
                    }
                    throw new Error('Video not found in API response');
                });
        }

        // Fallback: create a temporary hidden player, cue the video, read duration, then destroy it.
        return new Promise((resolve) => {
            // Ensure YT API is loaded
            const ensureApi = (cb) => {
                if (typeof YT !== 'undefined' && YT.Player) return cb();
                const wait = setInterval(() => {
                    if (typeof YT !== 'undefined' && YT.Player) {
                        clearInterval(wait);
                        cb();
                    }
                }, 100);
            };

            ensureApi(() => {
                const tempId = 'yt-temp-player-' + Math.random().toString(36).slice(2, 9);
                const tempDiv = document.createElement('div');
                tempDiv.id = tempId;
                tempDiv.style.width = '1px';
                tempDiv.style.height = '1px';
                tempDiv.style.opacity = '0';
                tempDiv.style.position = 'absolute';
                tempDiv.style.pointerEvents = 'none';
                document.body.appendChild(tempDiv);

                const tempPlayer = new YT.Player(tempId, {
                    height: '1',
                    width: '1',
                    playerVars: { controls: 0, modestbranding: 1, rel: 0 },
                    events: {
                        onReady: function() {
                            try {
                                tempPlayer.cueVideoById(videoId);
                            } catch (e) {
                                // if cue fails, resolve with 0
                                tempPlayer.destroy();
                                tempDiv.remove();
                                resolve(0);
                            }
                        }
                    }
                });

                const poll = setInterval(() => {
                    try {
                        const d = tempPlayer.getDuration();
                        if (d && d > 0) {
                            clearInterval(poll);
                            tempPlayer.destroy();
                            tempDiv.remove();
                            resolve(Math.floor(d));
                        }
                    } catch (e) {
                        // getDuration not ready yet, keep polling
                    }
                }, 200);
                // safety timeout
                setTimeout(() => {
                    clearInterval(poll);
                    try { tempPlayer.destroy(); } catch (e) {}
                    try { tempDiv.remove(); } catch (e) {}
                    resolve(0);
                }, 8000);
            });
        });
    };

    getVideoDuration(currentSong.videoId).then((duration) => {
        // pick a safe start time: at least 10s in, and ensure we have at least 30s to play
        const minStart = 10;
        const minDurationNeeded = 40; // need at least 30s of playback
        const latestStart = duration > minDurationNeeded ? duration - 30 : minStart;
        const startSeconds = latestStart <= minStart ? minStart : Math.floor(Math.random() * (latestStart - minStart + 1)) + minStart;

        // On desktop: autoplay. On mobile: require button click
        const autoplayParam = isMobile ? '' : '&autoplay=1';
        playerDiv.innerHTML = `<iframe id="yt-iframe" width="1" height="1" 
            src="https://www.youtube.com/embed/${currentSong.videoId}?enablejsapi=1&start=${startSeconds}${autoplayParam}&loop=1&playlist=${currentSong.videoId}" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            style="opacity: 0; position: absolute; pointer-events: none;">
        </iframe>`;
        
        if (!isMobile) {
            // Auto-start on desktop - wait a bit longer for audio to actually start
            setTimeout(() => {
                playAudioBtn.classList.add('hidden');
                songTitleDiv.textContent = '♪ Now playing...';
                guessGooseBtn.disabled = false;
                guessGeeseBtn.disabled = false;
            }, 1000);
        }
    }).catch((err) => {
        console.warn('Could not get video duration, falling back to immediate start', err);
        const autoplayParam = isMobile ? '' : '&autoplay=1';
        const playerDiv = document.getElementById('youtube-player');
        playerDiv.innerHTML = `<iframe id="yt-iframe" width="1" height="1" 
            src="https://www.youtube.com/embed/${currentSong.videoId}?enablejsapi=1&start=10${autoplayParam}&loop=1&playlist=${currentSong.videoId}" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            style="opacity: 0; position: absolute; pointer-events: none;">
        </iframe>`;
        
        if (!isMobile) {
            setTimeout(() => {
                playAudioBtn.classList.add('hidden');
                songTitleDiv.textContent = '♪ Now playing...';
                guessGooseBtn.disabled = false;
                guessGeeseBtn.disabled = false;
            }, 1000);
        }
    });
}

function startAudio() {
    // Use iframe postMessage API to play the video
    const iframe = document.getElementById('yt-iframe');
    if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        playAudioBtn.classList.add('hidden');
        songTitleDiv.textContent = '♪ Now playing...';
        
        // Enable guess buttons
        guessGooseBtn.disabled = false;
        guessGeeseBtn.disabled = false;
    }
}

function makeGuess(guess) {
    // Disable buttons
    guessGooseBtn.disabled = true;
    guessGeeseBtn.disabled = true;
    
    // Check if correct
    const isCorrect = guess === currentBand;
    
    // Update stats
    totalCount++;
    if (isCorrect) {
        correctCount++;
    }
    
    // Reveal song title
    songTitleDiv.textContent = `"${currentSong.title}" by ${currentBand.charAt(0).toUpperCase() + currentBand.slice(1)}`;
    songTitleDiv.style.fontStyle = 'normal';
    
    // Show result with deadpan responses
    resultDiv.classList.remove('hidden', 'correct', 'incorrect');
    resultDiv.classList.add(isCorrect ? 'correct' : 'incorrect');
    
    if (isCorrect) {
        const correctMessages = [
            "Flaptastic.",
            "Yes.",
            "That is correct.",
            "Accurate.",
            "Correct. It was " + currentBand.charAt(0).toUpperCase() + currentBand.slice(1) + ".",
            "You got it.",
            "That's right."
        ];
        resultDiv.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
    } else {
        const incorrectMessages = [
            "Incorrect. It was " + currentBand.charAt(0).toUpperCase() + currentBand.slice(1) + ".",
            "No. It was " + currentBand.charAt(0).toUpperCase() + currentBand.slice(1) + ".",
            "Wrong. " + currentBand.charAt(0).toUpperCase() + currentBand.slice(1) + ".",
            "That is incorrect.",
            "Not quite."
        ];
        resultDiv.textContent = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
    }
    
    // Update stats display
    correctCountSpan.textContent = correctCount;
    totalCountSpan.textContent = totalCount;
    statsDiv.classList.remove('hidden');
    
    // Show play again button
    setTimeout(() => {
        playRandomBtn.classList.remove('hidden');
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
            || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        playRandomBtn.innerHTML = isMobile ? 'Keep calm and<br>honk on' : 'Keep calm and honk on';
    }, 1000);
}
